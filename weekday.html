<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>

<script>
  // set the dimensions and margins of the graph
  var margin = { top: 30, right: 30, bottom: 70, left: 60 },
      width = 700 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;

  // append the svg object to the body of the page
  var svg = d3.select("#my_dataviz")
    .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // Parse the Data
  d3.csv("data.csv").then(function(data) {
    // Function to parse the date and get the weekday
    function getWeekday(dateStr) {
      const [day, month, year] = dateStr.split('/');
      const date = new Date(`${year}-${month}-${day}`);
      return date.toLocaleDateString('en-GB', { weekday: 'long' });
    }
    const parsedData = data.map(entry => {
        const [dateStr, , , , , , name, amount] = entry.split(',');
        const weekday = getWeekday(dateStr);
        return { name, weekday, amount };
        });

    // Add a weekday field to each data entry
    data.forEach(d => {
      d.WEEKDAY = getWeekday(d.DATE);
    });

    // Group data by person and weekday
    const groupedData = d3.rollup(data, 
      v => d3.sum(v, d => d.AMOUNT),
      d => d.PERSON, 
      d => d.WEEKDAY
    );

    // Prepare data for visualization
    const processedData = [];
    groupedData.forEach((weekdayAmounts, person) => {
      weekdayAmounts.forEach((amount, weekday) => {
        processedData.push({ person, weekday, amount });
      });
    });



    // Define unique weekdays and persons
    const uniqueWeekdays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
    const uniquePersons = [...groupedData.keys()];

    // Define x scale
    var x = d3.scaleBand()
      .range([0, width])
      .domain(uniqueWeekdays)
      .padding(0.2);

    // Append x-axis to SVG
    svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x))
      .selectAll("text")
        .attr("transform", "translate(-10,0)rotate(-45)")
        .style("text-anchor", "end");

    // Define y scale
    var y = d3.scaleLinear()
      .domain([0, d3.max(processedData, d => d.amount)])
      .range([height, 0]);

    // Append y-axis to SVG
    svg.append("g")
      .call(d3.axisLeft(y));

    // Define color scale
    var myColors = ["#ead1dc", "#c3d4f1", "#f9cb9c", "#d9ead3", "#fff2cc"];
    var colorScale = d3.scaleOrdinal()
      .domain(uniquePersons)
      .range(myColors);

    // Create bars
    svg.selectAll("mybar")
      .data(processedData)
      .enter()
      .append("rect")
        .attr("x", function(d) { return x(d.weekday); })
        .attr("y", function(d) { return y(d.amount); })
        .attr("width", x.bandwidth())
        .attr("height", function(d) { return height - y(d.amount); })
        .attr("fill", function(d) { return colorScale(d.person); })
        .attr("class", function(d) { return "person-" + d.person.replace(/\s/g, '-'); }); // Add a class to each bar for filtering

    // Legend
    var legend = svg.selectAll(".legend")
      .data(uniquePersons)
      .enter().append("g")
        .attr("class", "legend")
        .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

    legend.append("rect")
      .attr("x", width - 18)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", colorScale);

    legend.append("text")
      .attr("x", width - 24)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { return d; });
  });
</script>
